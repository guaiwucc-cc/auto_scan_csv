# 从配置文件中获取目标文件夹路径
$config = Get-Content -Path ".\config.json" -ErrorAction Stop
$folder = $config.Trim()

# 定义检查文件夹的函数
function Check-Folder {
    # 获取文件夹下的所有 CSV 文件
    $files = Get-ChildItem -Path $folder -Filter "*.csv"
    foreach ($file in $files) {
        # 转换 CSV 文件为 Excel 文件
        ConvertTo-Excel -FilePath $file.FullName
    }
}

# 定义转换为 Excel 文件的函数
function ConvertTo-Excel {
    [CmdletBinding()]
    param (
        [Parameter(Mandatory = $true)]
        [string]$FilePath
    )

    $excel = New-Object -ComObject Excel.Application
    $excel.Visible = $false
    $excel.DisplayAlerts = $false
    $workbook = $excel.Workbooks.Open($FilePath)
    $worksheet = $workbook.ActiveSheet
    $excelPath = $FilePath -replace '\.csv$', '.xlsx'
    $workbook.SaveAs($excelPath, [Microsoft.Office.Interop.Excel.XlFileFormat]::xlOpenXMLWorkbook)
    $workbook.Close()
    $excel.Quit()
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($worksheet) | Out-Null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workbook) | Out-Null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($excel) | Out-Null
}

# 每隔五分钟执行一次检查
while ($true) {
    Check-Folder
    Start-Sleep -Seconds 300
}